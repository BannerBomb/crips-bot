<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/Bridge.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Base.html">Base</a><ul class='methods'><li data-type='method'><a href="Base.html#deleteMessages">deleteMessages</a></li><li data-type='method'><a href="Base.html#edit">edit</a></li><li data-type='method'><a href="Base.html#hasPermissions">hasPermissions</a></li><li data-type='method'><a href="Base.html#send">send</a></li><li data-type='method'><a href="Base.html#t">t</a></li></ul></li><li><a href="Bridge.html">Bridge</a><ul class='methods'><li data-type='method'><a href="Bridge.html#collect">collect</a></li><li data-type='method'><a href="Bridge.html#destroy">destroy</a></li><li data-type='method'><a href="Bridge.html#handle">handle</a></li><li data-type='method'><a href="Bridge.html#push">push</a></li><li data-type='method'><a href="Bridge.html#register">register</a></li><li data-type='method'><a href="Bridge.html#reload">reload</a></li><li data-type='method'><a href="Bridge.html#run">run</a></li><li data-type='method'><a href="Bridge.html#stop">stop</a></li><li data-type='method'><a href="Bridge.html#unregister">unregister</a></li></ul></li><li><a href="Client.html">Client</a><ul class='methods'><li data-type='method'><a href="Client.html#createPlugin">createPlugin</a></li><li data-type='method'><a href="Client.html#register">register</a></li><li data-type='method'><a href="Client.html#run">run</a></li><li data-type='method'><a href="Client.html#unload">unload</a></li><li data-type='method'><a href="Client.html#unregister">unregister</a></li></ul></li><li><a href="Collection.html">Collection</a><ul class='methods'><li data-type='method'><a href="Collection.html#filter">filter</a></li><li data-type='method'><a href="Collection.html#find">find</a></li><li data-type='method'><a href="Collection.html#forEach">forEach</a></li><li data-type='method'><a href="Collection.html#groupBy">groupBy</a></li><li data-type='method'><a href="Collection.html#map">map</a></li><li data-type='method'><a href="Collection.html#pluck">pluck</a></li><li data-type='method'><a href="Collection.html#reduce">reduce</a></li><li data-type='method'><a href="Collection.html#toArray">toArray</a></li><li data-type='method'><a href="Collection.html#unique">unique</a></li></ul></li><li><a href="Command.html">Command</a><ul class='methods'><li data-type='method'><a href="Command.html#_verify">_verify</a></li><li data-type='method'><a href="Command.html#check">check</a></li><li data-type='method'><a href="Command.html#deleteMessages">deleteMessages</a></li><li data-type='method'><a href="Command.html#edit">edit</a></li><li data-type='method'><a href="Command.html#execute">execute</a></li><li data-type='method'><a href="Command.html#handle">handle</a></li><li data-type='method'><a href="Command.html#hasPermissions">hasPermissions</a></li><li data-type='method'><a href="Command.html#send">send</a></li><li data-type='method'><a href="Command.html#t">t</a></li></ul></li><li><a href="Commander.html">Commander</a><ul class='methods'><li data-type='method'><a href="Commander.html#attach">attach</a></li><li data-type='method'><a href="Commander.html#eject">eject</a></li><li data-type='method'><a href="Commander.html#ejectGroup">ejectGroup</a></li><li data-type='method'><a href="Commander.html#execute">execute</a></li><li data-type='method'><a href="Commander.html#register">register</a></li><li data-type='method'><a href="Commander.html#reload">reload</a></li><li data-type='method'><a href="Commander.html#unregister">unregister</a></li></ul></li><li><a href="Database.html">Database</a></li><li><a href="Interpreter.html">Interpreter</a><ul class='methods'><li data-type='method'><a href="Interpreter.html#getStrings">getStrings</a></li><li data-type='method'><a href="Interpreter.html#locate">locate</a></li><li data-type='method'><a href="Interpreter.html#parse">parse</a></li><li data-type='method'><a href="Interpreter.html#register">register</a></li><li data-type='method'><a href="Interpreter.html#reload">reload</a></li><li data-type='method'><a href="Interpreter.html#shift">shift</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#debug">debug</a></li><li data-type='method'><a href="Logger.html#error">error</a></li><li data-type='method'><a href="Logger.html#info">info</a></li><li data-type='method'><a href="Logger.html#log">log</a></li><li data-type='method'><a href="Logger.html#supportsColours">supportsColours</a></li><li data-type='method'><a href="Logger.html#warn">warn</a></li></ul></li><li><a href="Permitter.html">Permitter</a><ul class='methods'><li data-type='method'><a href="Permitter.html#.allow">allow</a></li><li data-type='method'><a href="Permitter.html#.deny">deny</a></li><li data-type='method'><a href="Permitter.html#.grant">grant</a></li><li data-type='method'><a href="Permitter.html#.verifyMessage">verifyMessage</a></li><li data-type='method'><a href="Permitter.html#check">check</a></li></ul></li><li><a href="Resolver.html">Resolver</a><ul class='methods'><li data-type='method'><a href="Resolver.html#getUsage">getUsage</a></li><li data-type='method'><a href="Resolver.html#load">load</a></li><li data-type='method'><a href="Resolver.html#loadResolvers">loadResolvers</a></li><li data-type='method'><a href="Resolver.html#resolve">resolve</a></li><li data-type='method'><a href="Resolver.html#verify">verify</a></li></ul></li><li><a href="Router.html">Router</a><ul class='methods'><li data-type='method'><a href="Router.html#attach">attach</a></li><li data-type='method'><a href="Router.html#destroy">destroy</a></li><li data-type='method'><a href="Router.html#initAll">initAll</a></li><li data-type='method'><a href="Router.html#record">record</a></li><li data-type='method'><a href="Router.html#register">register</a></li><li data-type='method'><a href="Router.html#reload">reload</a></li><li data-type='method'><a href="Router.html#unregister">unregister</a></li></ul></li><li><a href="Transmitter.html">Transmitter</a><ul class='methods'><li data-type='method'><a href="Transmitter.html#awaitResponse">awaitResponse</a></li><li data-type='method'><a href="Transmitter.html#register">register</a></li><li data-type='method'><a href="Transmitter.html#send">send</a></li><li data-type='method'><a href="Transmitter.html#unregister">unregister</a></li></ul></li><li><a href="Utils.html">Utils</a><ul class='methods'><li data-type='method'><a href="Utils.html#.delay">delay</a></li><li data-type='method'><a href="Utils.html#.getColour">getColour</a></li><li data-type='method'><a href="Utils.html#.hasRoleHierarchy">hasRoleHierarchy</a></li><li data-type='method'><a href="Utils.html#.isDir">isDir</a></li><li data-type='method'><a href="Utils.html#.padEnd">padEnd</a></li><li data-type='method'><a href="Utils.html#.padStart">padStart</a></li><li data-type='method'><a href="Utils.html#.parseNumber">parseNumber</a></li><li data-type='method'><a href="Utils.html#.readdirRecursive">readdirRecursive</a></li><li data-type='method'><a href="Utils.html#.requireAll">requireAll</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-_Eris.Client_.html">Eris.Client</a></li><li><a href="external-_Eris.Guild_.html">Eris.Guild</a></li><li><a href="external-_Eris.GuildChannel_.html">Eris.GuildChannel</a></li><li><a href="external-_Eris.Member_.html">Eris.Member</a></li><li><a href="external-_Eris.Message_.html">Eris.Message</a></li><li><a href="external-_Eris.Role_.html">Eris.Role</a></li><li><a href="external-_Eris.User_.html">Eris.User</a></li></ul><h3>Events</h3><ul><li><a href="Client.html#event:commander:commandError">commander:commandError</a></li><li><a href="Client.html#event:commander:ejected">commander:ejected</a></li><li><a href="Client.html#event:commander:ejectedGroup">commander:ejectedGroup</a></li><li><a href="Client.html#event:commander:error">commander:error</a></li><li><a href="Client.html#event:commander:registered">commander:registered</a></li><li><a href="Client.html#event:ipc:error">ipc:error</a></li><li><a href="Client.html#event:router:error">router:error</a></li><li><a href="Client.html#event:router:runError">router:runError</a></li></ul><h3>Namespaces</h3><ul><li><a href="Collector.html">Collector</a><ul class='methods'><li data-type='method'><a href="Collector.html#.collector.next">collector.next</a></li><li data-type='method'><a href="Collector.html#.collector.passMessage">collector.passMessage</a></li><li data-type='method'><a href="Collector.html#.collector.stop">collector.stop</a></li></ul></li><li><a href="CommandUsage.html">CommandUsage</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">core/Bridge.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const path = require('path')
const fs = require('fs')

const { readdirRecursive, isDir } = require('../util')

/**
 * Middleware manager for commands
 * @prop {Array} tasks An array of middleware
 * @prop {Array} collectors An array of message collectors
 */
class Bridge {
  /**
   * Creates a new Bridge instance
   * @arg {Client} client Client instance
   */
  constructor (client) {
    this.tasks = []
    this.collectors = []
    this._cached = []
    this._client = client
    this._commander = client.plugins.get('commands')
  }

  /**
   * Registers middleware
   * @arg {String|Object|Array} middleware An object, array or relative path to a folder or file to load middleware from
   * @returns {Client}
   */
  register (middleware) {
    switch (typeof middleware) {
      case 'string': {
        const filepath = path.isAbsolute(middleware) ? middleware : path.join(process.cwd(), middleware)
        if (!fs.existsSync(filepath)) {
          throw new Error(`Folder path ${filepath} does not exist`)
        }
        this._cached.push(filepath)
        const mw = isDir(filepath) ? readdirRecursive(filepath) : require(filepath)
        return this.register(mw)
      }
      case 'object': {
        if (Array.isArray(middleware)) {
          for (const mw of middleware) {
            this.push(mw)
          }
          return this
        }
        for (const key in middleware) {
          this.push(middleware[key])
        }
        return this
      }
      default: {
        throw new Error('Path supplied is not an object or string')
      }
    }
  }

  /**
   * Methods that parses messages and adds properties to a context container
   * @typedef {Object} Middleware
   * @prop {String} name Name of middleware
   * @prop {Number} priority Priority level of the middleware
   * @prop {Promise(Container)} process Middleware process
   */

  /**
   * Inserts new middleware to the task queue according to ascending priority (lower numbers are earlier in queue)
   * @arg {Middleware} middleware Middleware object
   */
  push (Middleware) {
    const middleware = typeof Middleware === 'function' ? new Middleware(this) : Middleware
    this.tasks.push(middleware)
    this.tasks.sort((a, b) => a.priority - b.priority)
  }

  /**
   * Creates a message collector
   * @arg {Object} options Collector options
   * @arg {String} options.filter The filter function to pass all messages through
   * @arg {String} [options.channel] The channel ID to filter messages from
   * @arg {String} [options.author] The author ID to filter messages from
   * @arg {Number} [options.tries=10] Max number of attempts to filter a message
   * @arg {Number} [options.time=60] Max length of time to wait for messages, in seconds
   * @arg {Number} [options.matches=10] Max number of successful filtered messages
   * @returns {Collector} Message collector object
   */
  collect (options = {}) {
    const { tries = 10, time = 60, matches = 10, channel, author, filter } = options

    /**
     * Message collector object, intended for menus
     * @namespace Collector
     * @type {Object}
     */
    const collector = {
      /**
       * An array of collected messages
       * @memberof Collector
       * @type {Array}
       */
      collected: [],
      _tries: 0,
      _matches: 0,
      _listening: false,
      _ended: false,
      _timer: time ? setTimeout(() => {
        collector._ended = {
          reason: 'timeout',
          arg: time,
          collected: collector.collected
        }
      }, time * 1000) : null
    }
    /**
     * Stop collecting messages
     * @memberof Collector
     * @method
     */
    collector.stop = () => {
      collector._listening = false
      this.collectors.splice(this.collectors.indexOf(collector), 1)
    }
    /**
     * Resolves when message is collected, and rejects when collector has ended
     * @memberof Collector
     * @returns {Promise&lt;external:"Eris.Message">}
     */
    collector.next = () => {
      return new Promise((resolve, reject) => {
        collector._resolve = resolve
        if (collector._ended) {
          collector.stop()
          reject(collector._ended)
        }
        collector._listening = true
      })
    }
    /**
     * Pass a message object to be filtered
     * @memberof Collector
     * @method
     * @returns {Boolean}
     */
    collector.passMessage = msg => {
      if (!collector._listening) return false
      if (author &amp;&amp; author !== msg.author.id) return false
      if (channel &amp;&amp; channel !== msg.channel.id) return false
      if (typeof filter === 'function' &amp;&amp; !filter(msg)) return false

      collector.collected.push(msg)
      if (collector.collected.size >= matches) {
        collector._ended = { reason: 'maxMatches', arg: matches }
      } else if (tries &amp;&amp; collector.collected.size === tries) {
        collector._ended = { reason: 'max', arg: tries }
      }
      collector._resolve(msg)
      return true
    }
    this.collectors.push(collector)
    return collector
  }

  /**
   * Destroy all tasks and collectors
   */
  destroy () {
    this.tasks = []
    this.collectors = []
  }

  /**
   * Remove middleware by name and returns it if found
   * @arg {String} name Middleware name
   * @returns {?Middleware}
   */
  unregister (name) {
    const middleware = this.tasks.find(mw => mw.name === name)
    if (!middleware) return null
    this.tasks.splice(this.tasks.indexOf(middleware, 1))
    return middleware
  }

  /**
   * Reloads middleware files (only those that have been added from by file path)
   * @returns {Client}
   */
  reload () {
    for (const filepath of this._cached) {
      this._client.unload(filepath)
      this._cached.shift()
      this.register(filepath)
    }
    return this
  }

  /** Starts running the bridge */
  run () {
    this._client.on('messageCreate', msg => {
      if (msg.author.id === this._client.user.id || msg.author.bot) return
      this.handle({
        msg: msg,
        client: this._client,
        logger: this._client.logger,
        admins: this._client.admins,
        commands: this._commander,
        modules: this._client.plugins.get('modules'),
        middleware: this
      }).catch(err => {
        if (err &amp;&amp; this._client.logger) {
          this._client.logger.error('Failed to handle message in Bridge -', err)
        }
      })
    })
  }

  /** Stops running the bridge */
  stop () {
    this._client.removeAllListeners('messageCreate')
  }

  /**
   * Context container holding a message object along with added properties and objects
   * @typedef {Object} Container
   * @prop {external:"Eris.Message"} msg The message object
   * @prop {Client} client The client object
   * @prop {String} trigger The command trigger&lt;br />
   * At least one middleware should add this into the container; default middleware does it for you
   */

  /**
   * Collects and executes messages after running them through middleware
   * @arg {Container} container The message container
   * @returns {Promise&lt;Container>}
   */
  async handle (container) {
    const { msg } = container
    for (let collector of this.collectors) {
      const collected = collector.passMessage(msg)
      if (collected) return Promise.reject()
    }
    for (const task of this.tasks) {
      try {
        const result = await task.process(container)
        if (!result) return Promise.reject()
        container = result
      } catch (err) {
        throw err
      }
    }
    try {
      if (!container.trigger) return Promise.reject()
      this._commander.execute(container.trigger, container)
    } catch (err) {
      throw err
    }
    return container
  }
}

module.exports = Bridge
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon Jan 02 2017 18:08:57 GMT+0800 (SGT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>

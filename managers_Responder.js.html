<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>managers/Responder.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Base.html">Base</a><ul class='methods'><li data-type='method'><a href="Base.html#deleteMessages">deleteMessages</a></li><li data-type='method'><a href="Base.html#edit">edit</a></li><li data-type='method'><a href="Base.html#hasPermissions">hasPermissions</a></li><li data-type='method'><a href="Base.html#send">send</a></li><li data-type='method'><a href="Base.html#t">t</a></li></ul></li><li><a href="Bridge.html">Bridge</a><ul class='methods'><li data-type='method'><a href="Bridge.html#collect">collect</a></li><li data-type='method'><a href="Bridge.html#destroy">destroy</a></li><li data-type='method'><a href="Bridge.html#handle">handle</a></li><li data-type='method'><a href="Bridge.html#push">push</a></li><li data-type='method'><a href="Bridge.html#register">register</a></li><li data-type='method'><a href="Bridge.html#reload">reload</a></li><li data-type='method'><a href="Bridge.html#run">run</a></li><li data-type='method'><a href="Bridge.html#stop">stop</a></li><li data-type='method'><a href="Bridge.html#unregister">unregister</a></li></ul></li><li><a href="Client.html">Client</a><ul class='methods'><li data-type='method'><a href="Client.html#createPlugin">createPlugin</a></li><li data-type='method'><a href="Client.html#register">register</a></li><li data-type='method'><a href="Client.html#run">run</a></li><li data-type='method'><a href="Client.html#unload">unload</a></li><li data-type='method'><a href="Client.html#unregister">unregister</a></li></ul></li><li><a href="Cluster.html">Cluster</a><ul class='methods'><li data-type='method'><a href="Cluster.html#awaitResponse">awaitResponse</a></li></ul></li><li><a href="Collection.html">Collection</a><ul class='methods'><li data-type='method'><a href="Collection.html#filter">filter</a></li><li data-type='method'><a href="Collection.html#find">find</a></li><li data-type='method'><a href="Collection.html#forEach">forEach</a></li><li data-type='method'><a href="Collection.html#groupBy">groupBy</a></li><li data-type='method'><a href="Collection.html#map">map</a></li><li data-type='method'><a href="Collection.html#pluck">pluck</a></li><li data-type='method'><a href="Collection.html#reduce">reduce</a></li><li data-type='method'><a href="Collection.html#toArray">toArray</a></li><li data-type='method'><a href="Collection.html#unique">unique</a></li></ul></li><li><a href="Command.html">Command</a><ul class='methods'><li data-type='method'><a href="Command.html#check">check</a></li><li data-type='method'><a href="Command.html#deleteMessages">deleteMessages</a></li><li data-type='method'><a href="Command.html#edit">edit</a></li><li data-type='method'><a href="Command.html#execute">execute</a></li><li data-type='method'><a href="Command.html#handle">handle</a></li><li data-type='method'><a href="Command.html#hasPermissions">hasPermissions</a></li><li data-type='method'><a href="Command.html#send">send</a></li><li data-type='method'><a href="Command.html#t">t</a></li></ul></li><li><a href="Commander.html">Commander</a><ul class='methods'><li data-type='method'><a href="Commander.html#attach">attach</a></li><li data-type='method'><a href="Commander.html#eject">eject</a></li><li data-type='method'><a href="Commander.html#ejectGroup">ejectGroup</a></li><li data-type='method'><a href="Commander.html#execute">execute</a></li><li data-type='method'><a href="Commander.html#register">register</a></li><li data-type='method'><a href="Commander.html#reload">reload</a></li><li data-type='method'><a href="Commander.html#unregister">unregister</a></li></ul></li><li><a href="Crystal.html">Crystal</a><ul class='methods'><li data-type='method'><a href="Crystal.html#createCluster">createCluster</a></li><li data-type='method'><a href="Crystal.html#createClusters">createClusters</a></li><li data-type='method'><a href="Crystal.html#getCluster">getCluster</a></li><li data-type='method'><a href="Crystal.html#restart">restart</a></li></ul></li><li><a href="Interpreter.html">Interpreter</a><ul class='methods'><li data-type='method'><a href="Interpreter.html#getStrings">getStrings</a></li><li data-type='method'><a href="Interpreter.html#locate">locate</a></li><li data-type='method'><a href="Interpreter.html#parse">parse</a></li><li data-type='method'><a href="Interpreter.html#register">register</a></li><li data-type='method'><a href="Interpreter.html#reload">reload</a></li><li data-type='method'><a href="Interpreter.html#shift">shift</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#debug">debug</a></li><li data-type='method'><a href="Logger.html#error">error</a></li><li data-type='method'><a href="Logger.html#info">info</a></li><li data-type='method'><a href="Logger.html#log">log</a></li><li data-type='method'><a href="Logger.html#register">register</a></li><li data-type='method'><a href="Logger.html#supportsColours">supportsColours</a></li><li data-type='method'><a href="Logger.html#warn">warn</a></li></ul></li><li><a href="Module.html">Module</a><ul class='methods'><li data-type='method'><a href="Module.html#deleteMessages">deleteMessages</a></li><li data-type='method'><a href="Module.html#edit">edit</a></li><li data-type='method'><a href="Module.html#hasPermissions">hasPermissions</a></li><li data-type='method'><a href="Module.html#init">init</a></li><li data-type='method'><a href="Module.html#send">send</a></li><li data-type='method'><a href="Module.html#t">t</a></li><li data-type='method'><a href="Module.html#unload">unload</a></li></ul></li><li><a href="Permitter.html">Permitter</a><ul class='methods'><li data-type='method'><a href="Permitter.html#.allow">allow</a></li><li data-type='method'><a href="Permitter.html#.deny">deny</a></li><li data-type='method'><a href="Permitter.html#.grant">grant</a></li><li data-type='method'><a href="Permitter.html#.verifyMessage">verifyMessage</a></li><li data-type='method'><a href="Permitter.html#check">check</a></li></ul></li><li><a href="Resolver.html">Resolver</a><ul class='methods'><li data-type='method'><a href="Resolver.html#getUsage">getUsage</a></li><li data-type='method'><a href="Resolver.html#load">load</a></li><li data-type='method'><a href="Resolver.html#loadResolvers">loadResolvers</a></li><li data-type='method'><a href="Resolver.html#resolve">resolve</a></li><li data-type='method'><a href="Resolver.html#verify">verify</a></li></ul></li><li><a href="Router.html">Router</a><ul class='methods'><li data-type='method'><a href="Router.html#attach">attach</a></li><li data-type='method'><a href="Router.html#destroy">destroy</a></li><li data-type='method'><a href="Router.html#initAll">initAll</a></li><li data-type='method'><a href="Router.html#record">record</a></li><li data-type='method'><a href="Router.html#register">register</a></li><li data-type='method'><a href="Router.html#reload">reload</a></li><li data-type='method'><a href="Router.html#unregister">unregister</a></li></ul></li><li><a href="Transmitter.html">Transmitter</a><ul class='methods'><li data-type='method'><a href="Transmitter.html#awaitResponse">awaitResponse</a></li><li data-type='method'><a href="Transmitter.html#register">register</a></li><li data-type='method'><a href="Transmitter.html#send">send</a></li><li data-type='method'><a href="Transmitter.html#unregister">unregister</a></li></ul></li><li><a href="Utils.html">Utils</a><ul class='methods'><li data-type='method'><a href="Utils.html#.delay">delay</a></li><li data-type='method'><a href="Utils.html#.getColour">getColour</a></li><li data-type='method'><a href="Utils.html#.hasRoleHierarchy">hasRoleHierarchy</a></li><li data-type='method'><a href="Utils.html#.isDir">isDir</a></li><li data-type='method'><a href="Utils.html#.padEnd">padEnd</a></li><li data-type='method'><a href="Utils.html#.padStart">padStart</a></li><li data-type='method'><a href="Utils.html#.parseNumber">parseNumber</a></li><li data-type='method'><a href="Utils.html#.requireAll">requireAll</a></li><li data-type='method'><a href="Utils.html#.requireRecursive">requireRecursive</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-_Eris.Client_.html">Eris.Client</a></li><li><a href="external-_Eris.Guild_.html">Eris.Guild</a></li><li><a href="external-_Eris.GuildChannel_.html">Eris.GuildChannel</a></li><li><a href="external-_Eris.Member_.html">Eris.Member</a></li><li><a href="external-_Eris.Message_.html">Eris.Message</a></li><li><a href="external-_Eris.Role_.html">Eris.Role</a></li><li><a href="external-_Eris.User_.html">Eris.User</a></li></ul><h3>Events</h3><ul><li><a href="Client.html#event:commander:commandError">commander:commandError</a></li><li><a href="Client.html#event:commander:ejected">commander:ejected</a></li><li><a href="Client.html#event:commander:ejectedGroup">commander:ejectedGroup</a></li><li><a href="Client.html#event:commander:error">commander:error</a></li><li><a href="Client.html#event:commander:registered">commander:registered</a></li><li><a href="Client.html#event:ipc:error">ipc:error</a></li><li><a href="Client.html#event:router:error">router:error</a></li><li><a href="Client.html#event:router:runError">router:runError</a></li></ul><h3>Namespaces</h3><ul><li><a href="Collector.html">Collector</a><ul class='methods'><li data-type='method'><a href="Collector.html#.collector.next">collector.next</a></li><li data-type='method'><a href="Collector.html#.collector.passMessage">collector.passMessage</a></li><li data-type='method'><a href="Collector.html#.collector.stop">collector.stop</a></li></ul></li><li><a href="CommandUsage.html">CommandUsage</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">managers/Responder.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>let Promise
try {
  Promise = require('bluebird')
} catch (err) {
  Promise = global.Promise
}

const { padEnd, emojis } = require('../util')

class Responder {
  constructor (command) {
    this.command = command
    this.i18n = command.i18n

    /** Response methods */
    this.responseMethods = {
      send: (msg, res) => res,
      reply: (msg, res) => `**${msg.author.username}**, ${res}`,
      success: (msg, res) => `${emojis['white_check_mark']}  |  **${msg.author.username}**, ${res}`,
      error: (msg, res) => `${emojis['negative_squared_cross_mark']}  |  **${msg.author.username}**, ` + (res || '{{%ERROR}}')
    }

    /** Formatter methods */
    this.formatMethods = {
      bold: (res) => `**${res}**`,
      italic: (res) => `*${res}*`,
      underline: (res) => `__${res}__`,
      strikethrough: (res) => `~~${res}~~`,
      inlineCode: (res) => `\`${res}\``,
      code: (res, type = '') => `\`\`\`${type}\n${res}\n\`\`\``,
      emoji: (res, type) => `${emojis[type] || emojis['information_source']}  |  ${res}`
    }
  }

  create ({ msg: message, settings = {} }, data) {
    let responder = Object.assign((...args) => responder.send(...args), {
      command: this.command,
      message: message,
      settings: settings,
      data: data,
      _options: {},
      responseMethods: this.responseMethods,
      formatMethods: this.formatMethods
    })

    const copy = ['_send', 't', 'clean', 'typing', 'format', 'file', 'embed', 'dialog', 'selection']
    copy.forEach(prop => { responder[prop] = this[prop].bind(responder) })

    for (let method in this.responseMethods) {
      responder[method] = responder._send.bind(responder, method)
    }

    return responder
  }

  t (content = '', tags = {}) {
    const cmd = this.command
    const file = cmd.name ? cmd.name.split(':')[0] : (cmd.labels ? cmd.labels[0] : 'common')
    const res = cmd.i18n.parse(content, cmd.localeKey || file, this.settings.lang || 'en', tags)
    return res.replace(/:(\S+):/gi, (matched, name) => emojis[name] || emojis['information_source'])
  }

  _send (method, response = '', options = {}) {
    const message = this.message
    const formats = this._formats || []

    Object.assign(options, this._options || {})

    if (response instanceof Array) response = response.join('\n')
    response = this.command.t(response, this.settings.lang || 'en', options)
    response = this.responseMethods[method || 'send'](message, response)

    for (let format of formats) {
      format = format.split(':')
      response = this.formatMethods[format[0]](response, format[1])
    }

    const promise = (options.DM ? this.command.bot.getDMChannel(message.author.id) : Promise.resolve(message.channel))
    .then(channel => this.command.send(channel, response, options))

    delete this._formats
    this._options = {}

    return promise
  }

  clean () {
    delete this._formats
    return this
  }

  typing () {
    return this.message.channel.sendTyping()
  }

  format (formats) {
    this._formats = (formats instanceof Array) ? formats : [formats]
    return this
  }

  file (name, file) {
    this._options.file = { name, file }
    return this
  }

  embed (embed) {
    this._options.embed = embed
    return this
  }

  async dialog (dialogs = [], options = {}) {
    const { message, data } = this
    const { tries = 10, time = 60, matches = 10, filter, cancel = 'cancel' } = options

    const args = {}
    let cancelled = false
    for (const dialog of dialogs) {
      let prompt = dialog.prompt
      const input = this.command.resolver
      if (Array.isArray(prompt) &amp;&amp; prompt.length) {
        prompt[0] = `**${prompt[0]}**`
      }

      let p1 = await this.send(prompt, options)
      const collector = this.command.bot.engine.bridge.collect({
        channel: message.channel.id,
        author: message.author.id,
        tries,
        time,
        matches,
        filter
      })

      const awaitMessage = async (msg) => {
        let ans
        try {
          ans = await collector.next()
          if (ans.content.toLowerCase() === cancel) return Promise.reject()
          try {
            return await input.resolve(ans, [ans.cleanContent], data, dialog.input)
          } catch (err) {
            const p2 = await this.format('emoji:error').send(
              `${err.err || err.message || err || '{{%menus.ERROR}}'}\n\n{{%menus.EXIT}}`,
              Object.assign(err, { cancel: `\`${cancel}\`` })
            )
            return awaitMessage(p2)
          }
        } catch (o) {
          return Promise.reject(o)
        } finally {
          this.command.deleteMessages(msg, ans)
        }
      }

      try {
        Object.assign(args, await awaitMessage())
        collector.stop()
      } catch (err) {
        if (typeof err !== 'undefined') {
          this.error(`{{%menus.ERRORED}} **{{%collector.${err.reason}}}**`, {
            [err.reason]: err.arg, err: `**${err.reason}**`
          })
        } else {
          this.success('{{%menus.EXITED}}')
        }
        collector.stop()
        cancelled = true
        break
      } finally {
        p1.delete()
      }
    }

    if (cancelled) return Promise.reject()
    return Promise.resolve(args)
  }

  async selection (selections = [], options = {}) {
    if (!Array.isArray(selections)) return [selections, 0]
    if (!selections.length) return []
    if (selections.length === 1) return [selections[0], 0]

    const { title = '{{%menus.SELECTION}}', footer = '{{%menus.INPUT}}', mapFunc } = options
    const choices = (mapFunc ? selections.map(mapFunc) : selections).splice(0, 10)

    try {
      const { reply } = await this.dialog([{
        prompt: [
          '```markdown',
          `### ${title} ###\n`,
          choices.map((c, i) => `${padEnd(`[${i + 1}]:`, 4)} ${c}`).join('\n'),
          selections.length > 10 ? '{{%menus.MORE_RESULTS}}\n' : '',
          Array.isArray(footer) ? footer.join('\n') : '> ' + footer,
          '```'
        ].join('\n'),
        input: { type: 'int', name: 'reply', min: 1, max: choices.length }
      }], Object.assign(options, {
        num: selections.length - 10, cancel: options.cancel || 'cancel'
      }))
      return [selections[reply - 1], reply - 1]
    } catch (err) {
      return []
    }
  }
}

module.exports = Responder
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Tue Jan 03 2017 12:46:08 GMT+0800 (SGT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
